<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex" />
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups" />
    <title>Binary Builders CMS - Authentication</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #000;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        flex-direction: column;
      }
      h1 {
        margin-bottom: 20px;
      }
    </style>
    <!-- Load Sveltia CMS -->
    <script src="https://unpkg.com/@sveltia/cms/dist/sveltia-cms.js"></script>
    <script>
      // Complete the authentication process
      (function() {
        console.log('Callback processing started');
        
        // Log URL for debugging
        console.log('Current URL:', window.location.href);
        
        // Check for hash fragment (implicit flow)
        const hash = window.location.hash.substring(1);
        const hashParams = new URLSearchParams(hash);
        const token = hashParams.get('access_token');
        
        // Check for query parameters (code flow)
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const error = urlParams.get('error');
        
        console.log('Auth params:', { 
          token: !!token, 
          code: !!code, 
          error 
        });
        
        if (token) {
          // Handle implicit flow
          document.body.innerHTML = `
            <h1>Authentication Successful</h1>
            <p>Completing login process, please wait...</p>
          `;
          
          // Store token for CMS
          localStorage.setItem('netlify-cms-user', JSON.stringify({
            token: {
              access_token: token
            }
          }));
          
          console.log('Token received, attempting to notify opener');
          
          // Signal to the opener that authentication is complete
          if (window.opener) {
            try {
              window.opener.postMessage(
                { 
                  type: 'netlify-cms:authentication',
                  payload: { token }
                },
                window.location.origin
              );
              console.log('Posted message to opener');
              setTimeout(() => window.close(), 1500);
            } catch (err) {
              console.error('Error posting message:', err);
              window.location.href = '/admin/';
            }
          } else {
            // Redirect to admin page if this is not a popup
            console.log('No opener found, redirecting');
            window.location.href = '/admin/';
          }
        } else if (code) {
          // Handle authorization code flow with PKCE
          document.body.innerHTML = `
            <h1>Authorization Code Received</h1>
            <p>Processing authentication...</p>
          `;
          
          console.log('Code received, initializing CMS for PKCE exchange');
          
          // Let Sveltia CMS handle the PKCE code exchange
          window.CMS.init({
            config: {
              backend: {
                name: 'github',
                repo: '01builders/binary.builders',
                app_id: 'Ov23li3KLpTEmp9FjuAK',
                auth_type: 'code',
                pkce: true
              }
            }
          });
          
          if (window.opener) {
            try {
              window.opener.postMessage(
                { 
                  type: 'netlify-cms:authentication',
                  payload: { code }
                },
                window.location.origin
              );
              setTimeout(() => window.close(), 1500);
            } catch (err) {
              console.error('Error posting message:', err);
              window.location.href = '/admin/';
            }
          } else {
            window.location.href = '/admin/';
          }
        } else if (error) {
          // Handle authentication error
          console.error('Auth error:', error);
          document.body.innerHTML = `
            <h1>Authentication Error</h1>
            <p>There was an error during authentication: ${error}</p>
            <button onclick="window.opener ? window.close() : window.location.href='/admin/'">
              ${window.opener ? 'Close' : 'Return to CMS'}
            </button>
          `;
        } else {
          // No auth information found
          console.warn('No auth params found');
          document.body.innerHTML = `
            <h1>Authentication Required</h1>
            <p>No authentication information found.</p>
            <button onclick="window.opener ? window.close() : window.location.href='/admin/'">
              ${window.opener ? 'Close' : 'Return to CMS'}
            </button>
          `;
        }
      })();
    </script>
  </head>
  <body>
    <h1>Authenticating...</h1>
    <p>Please wait while we complete the authentication process.</p>
  </body>
</html> 